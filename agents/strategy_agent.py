from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from state import AgentState
import os
from datetime import datetime
import re

def generate_revision_checklist(risk_reason: str) -> str:
    """
    æ ¹æ®é£æ§å®˜çš„å…·ä½“é©³å›ç†ç”±ç”Ÿæˆè¯¦ç»†çš„ä¿®å¤æ¸…å•
    
    Args:
        risk_reason: é£æ§å®˜æä¾›çš„é©³å›ç†ç”±
        
    Returns:
        æ ¼å¼åŒ–çš„ä¿®å¤æ¸…å•å­—ç¬¦ä¸²
    """
    checklist_items = []
    reason_lower = risk_reason.lower()
    
    # é€»è¾‘é—®é¢˜ç±»
    if any(keyword in risk_reason for keyword in ["é€»è¾‘çŸ›ç›¾", "é€»è¾‘ä¸ä¸€è‡´", "å‰åçŸ›ç›¾", "æ•°æ®å…¨æ˜¯åˆ©ç©º", "æ•°æ®åè´Ÿé¢"]):
        checklist_items.extend([
            "- [ ] é‡æ–°æ£€æŸ¥æ•°æ®ä¸ç»“è®ºçš„ä¸€è‡´æ€§ï¼Œç¡®ä¿é€»è¾‘é—­ç¯",
            "- [ ] å¦‚æ•°æ®åè´Ÿé¢ï¼Œå¿…é¡»åœ¨æŠ¥å‘Šä¸­æ˜ç¡®è§£é‡ŠåŸå› å¹¶æç¤ºç›¸åº”é£é™©",
            "- [ ] é¿å…ç›²ç›®ä¹è§‚ï¼Œç¡®ä¿ç»“è®ºæœ‰å……åˆ†çš„æ•°æ®æ”¯æ’‘",
            '- [ ] æ£€æŸ¥æ˜¯å¦å­˜åœ¨"æ•°æ®åˆ©ç©ºä½†ç»“è®ºçœ‹å¤š"çš„çŸ›ç›¾æƒ…å†µï¼Œå¦‚æœ‰éœ€ä¿®æ­£'
        ])
    
    # é£é™©æç¤ºä¸è¶³ç±»
    if any(keyword in risk_reason for keyword in ["é£é™©æç¤º", "é£é™©å¯¹å†²", "é£é™©è­¦ç¤º", "é£é™©ä¸è¶³", "ç¼ºä¹é£é™©"]):
        checklist_items.extend([
            "- [ ] åœ¨ç»™å‡ºçœ‹å¤šå»ºè®®æ—¶ï¼ŒåŒæ­¥åˆ—å‡ºæ½œåœ¨çš„ä¸‹è¡Œé£é™©",
            "- [ ] å¢å¼ºé£é™©æç¤ºçš„å……åˆ†æ€§å’Œå…·ä½“æ€§",
            "- [ ] ç¡®ä¿é£é™©è­¦ç¤ºä¸æŠ•èµ„å»ºè®®ç›¸åŒ¹é…",
            "- [ ] è¡¥å……å…·ä½“çš„é‡åŒ–é£é™©æŒ‡æ ‡ï¼ˆå¦‚æœ€å¤§å›æ’¤ã€æ­¢æŸä½ç­‰ï¼‰"
        ])
    
    # æ•°æ®å‡†ç¡®æ€§é—®é¢˜ç±»
    if any(keyword in risk_reason for keyword in ["æ•°æ®å¼ å† ææˆ´", "æ•°æ®é”™è¯¯", "é‡å¤§ç¡¬ä¼¤", "æ•°æ®ä¸å‡†ç¡®", "æ•°æ®å¼•ç”¨é”™è¯¯"]):
        checklist_items.extend([
            "- [ ] ä»”ç»†æ ¸å¯¹æ‰€æœ‰å¼•ç”¨çš„æ•°æ®ï¼Œç¡®ä¿å‡†ç¡®æ€§",
            "- [ ] ä¿®æ­£æ•°æ®å¼•ç”¨é”™è¯¯ï¼Œç¡®ä¿æ•°æ®æ¥æºæ­£ç¡®",
            "- [ ] é¿å…å®Œå…¨æ— è§†å·²çŸ¥çš„é‡å¤§è´Ÿé¢ä¿¡æ¯",
            "- [ ] æ ¸å¯¹æŠ€æœ¯æŒ‡æ ‡çš„è®¡ç®—å‘¨æœŸå’Œæ•°å€¼æ˜¯å¦æ­£ç¡®"
        ])
    
    # èµ„è®¯åˆ†æé—®é¢˜ç±»
    if any(keyword in risk_reason for keyword in ["èµ„è®¯", "æ–°é—»", "ç ”æŠ¥", "èµ„è®¯ç»´åº¦", "èµ„è®¯è§£æ"]):
        checklist_items.extend([
            "- [ ] é‡æ–°å®¡è§†èµ„è®¯åˆ†æï¼Œç¡®ä¿å¯¹é‡å¤§æ–°é—»çš„è§£è¯»å‡†ç¡®",
            "- [ ] æ£€æŸ¥æ˜¯å¦é—æ¼äº†é‡è¦çš„è¡Œä¸šæ”¿ç­–æˆ–å®è§‚äº‹ä»¶",
            "- [ ] ç¡®ä¿èµ„è®¯æƒ…æ„Ÿè¯„åˆ†ä¸å®é™…å†…å®¹ç›¸ç¬¦"
        ])
    
    # æŠ€æœ¯åˆ†æé—®é¢˜ç±»
    if any(keyword in risk_reason for keyword in ["æŠ€æœ¯æŒ‡æ ‡", "æŠ€æœ¯é¢", "MACD", "RSI", "KDJ", "å¸ƒæ—å¸¦", "å‡çº¿"]):
        checklist_items.extend([
            "- [ ] é‡æ–°æ ¸å¯¹æŠ€æœ¯æŒ‡æ ‡çš„è®¡ç®—å‘¨æœŸå’Œæ•°å€¼",
            "- [ ] ç¡®ä¿æŠ€æœ¯æŒ‡æ ‡çš„è§£è¯»ä¸å®é™…æ•°å€¼ä¸€è‡´",
            "- [ ] æ£€æŸ¥æŠ€æœ¯å½¢æ€è¯†åˆ«æ˜¯å¦å‡†ç¡®",
            "- [ ] ç»Ÿä¸€æŠ€æœ¯æŒ‡æ ‡çš„å£å¾„æ ‡æ³¨ï¼ˆå¦‚ RSI(14æ—¥)ã€MACD(12,26,9)ï¼‰"
        ])
    
    # è´¢åŠ¡æ•°æ®é—®é¢˜ç±»
    if any(keyword in risk_reason for keyword in ["è´¢åŠ¡", "ROE", "å‡€åˆ©æ¶¦", "è¥æ”¶", "è´¢åŠ¡æ•°æ®"]):
        checklist_items.extend([
            "- [ ] é‡æ–°æ ¸å¯¹è´¢åŠ¡æ•°æ®çš„å‡†ç¡®æ€§å’Œæ—¶æ•ˆæ€§",
            "- [ ] æ£€æŸ¥è´¢åŠ¡æŒ‡æ ‡çš„è®¡ç®—æ˜¯å¦æ­£ç¡®",
            "- [ ] ç¡®ä¿è´¢åŠ¡æ•°æ®çš„æ¥æºå¯é "
        ])
    
    # è¡Œä¸šå¯¹æ¯”é—®é¢˜ç±»
    if any(keyword in risk_reason for keyword in ["è¡Œä¸šå¯¹æ¯”", "è¡Œä¸šæ•°æ®", "æ¿å—", "è¡Œä¸šæ’å"]):
        checklist_items.extend([
            "- [ ] é‡æ–°è·å–è¡Œä¸šå¯¹æ¯”æ•°æ®ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§",
            "- [ ] æ£€æŸ¥è¡Œä¸šæ’åå’Œå¯¹æ¯”æŒ‡æ ‡çš„å‡†ç¡®æ€§",
            '- [ ] å¦‚è¡Œä¸šæ•°æ®ä¸å¯ç”¨ï¼Œæ˜ç¡®æ ‡æ³¨"æ— æ³•è¯„ä¼°"'
        ])
    
    # èµ„é‡‘æµå‘é—®é¢˜ç±»
    if any(keyword in risk_reason for keyword in ["èµ„é‡‘æµå‘", "ä¸»åŠ›èµ„é‡‘", "åŒ—å‘èµ„é‡‘", "èµ„é‡‘é¢"]):
        checklist_items.extend([
            "- [ ] é‡æ–°åˆ†æèµ„é‡‘æµå‘æ•°æ®",
            "- [ ] æ£€æŸ¥ä¸»åŠ›èµ„é‡‘åŠ¨å‘çš„åˆ¤æ–­æ˜¯å¦å‡†ç¡®",
            "- [ ] ç¡®ä¿èµ„é‡‘é¢åˆ†æä¸å®é™…æ•°æ®ä¸€è‡´"
        ])
    
    # é€šç”¨é—®é¢˜ç±»ï¼ˆå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°å…·ä½“é—®é¢˜ï¼‰
    if not checklist_items:
        checklist_items.extend([
            "- [ ] é’ˆå¯¹é£æ§å®˜æå‡ºçš„å…·ä½“é—®é¢˜è¿›è¡Œé€æ¡ä¿®æ­£",
            "- [ ] ç¡®ä¿ä¿®æ­£åçš„æŠ¥å‘Šé€»è¾‘æ›´åŠ ä¸¥å¯†",
            "- [ ] å¢å¼ºé£é™©æç¤ºçš„å……åˆ†æ€§",
            "- [ ] é‡æ–°å®¡æ ¸æŠ¥å‘Šçš„æ•´ä½“é€»è¾‘å’Œç»“è®º"
        ])
    
    # å»é‡å¹¶æ ¼å¼åŒ–
    unique_items = list(dict.fromkeys(checklist_items))
    checklist = "### ğŸ“‹ ä¿®å¤æ¸…å• (å¿…é¡»é€é¡¹å›åº”)\n" + "\n".join(unique_items)
    
    return checklist

def strategy_agent_node(state: AgentState):
    """
    ç­–ç•¥ä¸»ç†äººï¼šç»¼åˆèµ„è®¯å’Œæ•°æ®ï¼Œç”ŸæˆæŠ•èµ„å»ºè®®
    """
    stock_code = state["stock_code"]
    stock_name = state["stock_name"]
    is_sector = state.get("is_sector", False)
    current_date = datetime.now().strftime("%Y-%m-%d")
    
    # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æˆ–ä¸­æ–­ä¿¡å·
    if state.get("error") or state.get("interrupted"):
        return {"messages": []}
    
    print(f"--- ğŸ§  ç­–ç•¥ä¸»ç†äºº: æ­£åœ¨ç»¼åˆåˆ†æ {stock_name}({stock_code}) [å½“å‰æ—¥æœŸ: {current_date}] ---")
    
    # ä» state ä¸­è·å–ç‹¬ç«‹é…ç½®
    config = state.get("config", {})
    model_name = config.get("model_name", "gpt-3.5-turbo")
    temperature = config.get("temperature", 0.5)
    max_tokens = config.get("max_tokens", 4096)
    api_base = config.get("api_base", "https://api.openai.com/v1")
    api_key = config.get("api_key")
    
    if not isinstance(api_key, str) or not api_key:
        return {"strategy_report": "Error: Invalid API Key"}

    # æ·±åº¦æ€è€ƒæ¨¡å¼é…ç½®
    model_kwargs = {}
    # NVIDIA/OpenAI æ¥å£é€šå¸¸ä¸éœ€è¦æ˜¾å¼è®¾ç½® include_reasoning

    llm = ChatOpenAI(
        model=model_name, 
        temperature=temperature, 
        max_tokens=max_tokens,
        base_url=api_base,
        api_key=api_key,
        model_kwargs=model_kwargs
    )

    # æ ¹æ®æ˜¯å¦æ˜¯æ¿å—è°ƒæ•´è§’è‰²å’Œä»»åŠ¡
    role_definition = "ä½ æ˜¯ä¸€ä½é¡¶çº§çš„åŸºé‡‘ç»ç†ï¼Œæ“…é•¿å®è§‚è¶‹åŠ¿åˆ¤æ–­ä¸ ETF èµ„äº§é…ç½®ã€‚" if is_sector else 'ä½ æ˜¯ä¸€ä½é¡¶çº§çš„å…¬å‹ŸåŸºé‡‘ç»ç†ï¼Œä»¥"ä»·å€¼é©±åŠ¨ã€é£é™©ä¼˜å…ˆã€æŠ€æœ¯æ‹©æ—¶"ä¸‰ä½ä¸€ä½“çš„æŠ•èµ„é£æ ¼è‘—ç§°ã€‚'
    task_description = f"åŸºäºå¤šç»´æ•°æ®ï¼Œä¸ºã€{stock_name}ã€‘æ¿å—æ’°å†™ä¸€ä»½æ·±åº¦çš„ ETF æŠ•èµ„å»ºè®®æŠ¥å‘Šã€‚" if is_sector else f"åŸºäºå¤šç»´æ•°æ®ï¼Œä¸ºè‚¡ç¥¨ã€{stock_name}({stock_code})ã€‘æ’°å†™ä¸€ä»½æ·±åº¦çš„æŠ•èµ„å»ºè®®æŠ¥å‘Šã€‚"
    
    # å°†æˆåˆ†è‚¡æ•°æ®ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œå¦‚æœæ˜¯æ¿å—åˆ†æåˆ™åŠ å…¥
    sector_cons_context = f"ã€4. æ¿å—æˆåˆ†è‚¡å¼ºå¼±ã€‘: {{sector_cons}}\n(æ³¨ï¼šæˆåˆ†è‚¡çš„è¡¨ç°å†³å®šäº†æ¿å—æŒ‡æ•°çš„ç¨³å®šæ€§ï¼Œè¯·ç»“åˆæˆåˆ†è‚¡è¡¨ç°ç»™å‡º ETF ç”³èµå»ºè®®)" if is_sector else ""

    # è·å–é£æ§åé¦ˆ
    risk_feedback = ""
    revision_checklist = ""
    if state.get("revision_needed"):
        risk_assessment = state.get("risk_assessment", {})
        
        # å¤„ç†ç»“æ„åŒ–çš„é£æ§è¯„ä¼°
        if isinstance(risk_assessment, dict):
            decision = risk_assessment.get("decision", "é©³å›")
            reason = risk_assessment.get("reason", "æœªæä¾›å…·ä½“ç†ç”±")
            review_count = risk_assessment.get("review_count", 1)
            
            risk_feedback = f"""
        ### âš ï¸ ä¿®æ­£è¯·æ±‚ (æ¥è‡ªé£æ§å®˜)
        ä½ ä¹‹å‰çš„æŠ¥å‘Šè¢«é©³å›äº†ï¼Œç†ç”±å¦‚ä¸‹ï¼š
        **å†³ç­–**: {decision}
        **å®¡æ ¸æ¬¡æ•°**: {review_count}
        **é©³å›ç†ç”±**: {reason}
        """
            
            # åŸºäºå…·ä½“çš„é£æ§ç†ç”±ç”Ÿæˆè¯¦ç»†çš„ä¿®å¤æ¸…å•
            revision_checklist = generate_revision_checklist(reason)
        else:
            # å…¼å®¹æ—§æ ¼å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰
            risk_feedback = f"""
        ### âš ï¸ ä¿®æ­£è¯·æ±‚ (æ¥è‡ªé£æ§å®˜)
        ä½ ä¹‹å‰çš„æŠ¥å‘Šè¢«é©³å›äº†ï¼Œç†ç”±å¦‚ä¸‹ï¼š
        {risk_assessment}
        """
            
            # æå–é£æ§ç†ç”±ä¸­çš„å…·ä½“é—®é¢˜ï¼Œç”Ÿæˆä¿®å¤æ¸…å•
            if "é€»è¾‘çŸ›ç›¾" in risk_assessment or "æ•°æ®å…¨æ˜¯åˆ©ç©º" in risk_assessment:
                revision_checklist = """
        ### ğŸ“‹ ä¿®å¤æ¸…å• (å¿…é¡»é€é¡¹å›åº”)
        - [ ] é‡æ–°æ£€æŸ¥æ•°æ®ä¸ç»“è®ºçš„ä¸€è‡´æ€§ï¼Œç¡®ä¿é€»è¾‘é—­ç¯
        - [ ] å¦‚æ•°æ®åè´Ÿé¢ï¼Œå¿…é¡»åœ¨æŠ¥å‘Šä¸­æ˜ç¡®è§£é‡ŠåŸå› å¹¶æç¤ºç›¸åº”é£é™©
        - [ ] é¿å…ç›²ç›®ä¹è§‚ï¼Œç¡®ä¿ç»“è®ºæœ‰å……åˆ†çš„æ•°æ®æ”¯æ’‘
        """
            elif "é£é™©æç¤º" in risk_assessment or "é£é™©å¯¹å†²" in risk_assessment:
                revision_checklist = """
        ### ğŸ“‹ ä¿®å¤æ¸…å• (å¿…é¡»é€é¡¹å›åº”)
        - [ ] åœ¨ç»™å‡ºçœ‹å¤šå»ºè®®æ—¶ï¼ŒåŒæ­¥åˆ—å‡ºæ½œåœ¨çš„ä¸‹è¡Œé£é™©
        - [ ] å¢å¼ºé£é™©æç¤ºçš„å……åˆ†æ€§å’Œå…·ä½“æ€§
        - [ ] ç¡®ä¿é£é™©è­¦ç¤ºä¸æŠ•èµ„å»ºè®®ç›¸åŒ¹é…
        """
            elif "æ•°æ®å¼ å† ææˆ´" in risk_assessment or "é‡å¤§ç¡¬ä¼¤" in risk_assessment:
                revision_checklist = """
        ### ğŸ“‹ ä¿®å¤æ¸…å• (å¿…é¡»é€é¡¹å›åº”)
        - [ ] ä»”ç»†æ ¸å¯¹æ‰€æœ‰å¼•ç”¨çš„æ•°æ®ï¼Œç¡®ä¿å‡†ç¡®æ€§
        - [ ] ä¿®æ­£æ•°æ®å¼•ç”¨é”™è¯¯ï¼Œç¡®ä¿æ•°æ®æ¥æºæ­£ç¡®
        - [ ] é¿å…å®Œå…¨æ— è§†å·²çŸ¥çš„é‡å¤§è´Ÿé¢ä¿¡æ¯
        """
            else:
                revision_checklist = """
        ### ğŸ“‹ ä¿®å¤æ¸…å• (å¿…é¡»é€é¡¹å›åº”)
        - [ ] é’ˆå¯¹é£æ§å®˜æå‡ºçš„å…·ä½“é—®é¢˜è¿›è¡Œé€æ¡ä¿®æ­£
        - [ ] ç¡®ä¿ä¿®æ­£åçš„æŠ¥å‘Šé€»è¾‘æ›´åŠ ä¸¥å¯†
        - [ ] å¢å¼ºé£é™©æç¤ºçš„å……åˆ†æ€§
        """

    prompt_template = f"""
    ### è§’è‰²å®šä¹‰
    {role_definition}
    
    ### ä»»åŠ¡æè¿°
    {task_description}
    **æ³¨æ„ï¼šä»Šå¤©æ˜¯ {current_date}ã€‚è¯·ç¡®ä¿æŠ¥å‘Šçš„æ—¶æ•ˆæ€§ä»¥æ­¤æ—¥æœŸä¸ºå‡†ã€‚**
    
    {risk_feedback}
    {revision_checklist}
    
    ### è¾“å…¥æ•°æ®æº
    ---
    ã€1. èµ„è®¯ä¸ç ”æŠ¥æ·±åº¦åˆ†æã€‘: 
    - æ ¸å¿ƒæ‘˜è¦: {{news_analysis}}
    - æƒ…æ„Ÿé‡åŒ–è¯„åˆ†: {{sentiment_score}} (-1 åˆ° 1)
    
    ã€2. è´¢åŠ¡/æ¿å—åŸºç¡€æ•°æ®ã€‘: 
    - æ ¸å¿ƒæŒ‡æ ‡: {{quant_data}}
    
    ã€3. æŠ€æœ¯é¢ä¸èµ„é‡‘æµå‘ã€‘: 
    - å…³é”®æŒ‡æ ‡: {{tech_indicators}}
    - (æ³¨ï¼šåŒ…å« MA å‡çº¿ç³»ç»Ÿ(5/10/20/60æ—¥)ã€MACD(12,26,9)ã€RSI(14æ—¥)ã€KDJ(9æ—¥)ã€BOLL å¸ƒæ—å¸¦(20æ—¥,2Ïƒ)ã€æˆäº¤é‡æ¯”ç‡åŠè‡ªåŠ¨è¯†åˆ«çš„æŠ€æœ¯å½¢æ€)
    - é‡è¦ï¼šæ‰€æœ‰æŠ€æœ¯æŒ‡æ ‡å‡å·²æ ‡æ³¨è®¡ç®—å‘¨æœŸï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§æ ‡æ³¨çš„å‘¨æœŸå‚æ•°è¿›è¡Œè§£è¯»ï¼Œç¦æ­¢éšæ„æ›´æ”¹å‘¨æœŸå‚æ•°
    
    {sector_cons_context}
    ---
    
    ### æ’°å†™è¦æ±‚
    1. **æ•°æ®ç»å¯¹çœŸç†åŸåˆ™**: æ‰€æœ‰çš„æŠ€æœ¯æŒ‡æ ‡å‡ç”±æœ¬åœ°ç²¾å¯†è®¡ç®—å¾—å‡ºã€‚**ä¸¥ç¦ä½ è¿›è¡Œä»»ä½•æ•°å­¦æ¨å¯¼æˆ–é‡æ–°è®¡ç®—**ã€‚
    2. **é€»è¾‘é—­ç¯**: ç»“è®ºå¿…é¡»ç”±æä¾›çš„æœ¬åœ°æ•°æ®æ”¯æ’‘ã€‚
    3. **å¤šç»´æ·±åº¦åˆ†æ**:
       - **èµ„è®¯ç»´åº¦**: ç»“åˆè¿‘æœŸè¡Œä¸šæ”¿ç­–ã€å®è§‚ç¯å¢ƒï¼Œè¯„ä¼°æ¿å—çš„èµ›é“ä»·å€¼ã€‚
       - **æŠ€æœ¯/èµ„é‡‘ç»´åº¦**: ç›´æ¥å¼•ç”¨æœ¬åœ°è®¡ç®—å‡ºçš„æŒ‡æ ‡ï¼Œè§£è¯»æ¿å—çš„è¶‹åŠ¿å¼ºåº¦æˆ–å˜ç›˜ç‚¹ã€‚
       - **æˆåˆ†è‚¡åˆ†æ (ä»…é™æ¿å—åˆ†æ)**: å¦‚æœæä¾›äº†æˆåˆ†è‚¡ï¼Œåˆ†ææƒé‡è‚¡çš„è¡¨ç°å¯¹æ¿å— ETF çš„å½±å“ã€‚
    4. **ä¸¥ç¦å¹»è§‰**: 
       - å¦‚æœæŸé¡¹æ•°æ®ç¼ºå¤±ï¼Œè¯·æ˜ç¡®è¯´æ˜"æ— æ³•è¯„ä¼°"ï¼Œç¦æ­¢ç›²ç›®çŒœæµ‹ã€‚
       - è´¢åŠ¡æ•°æ®ï¼ˆå¦‚è¥ä¸šæ€»æ”¶å…¥ã€ROEã€å‡€åˆ©æ¶¦ç­‰ï¼‰ç¼ºå¤±æ—¶ï¼Œå¿…é¡»åœ¨æŠ¥å‘Šä¸­æ ‡æ³¨"æ— æ³•è¯„ä¼°"ã€‚
       - æŠ€æœ¯æŒ‡æ ‡ç¼ºå¤±æ—¶ï¼Œå¿…é¡»è¯´æ˜"æ•°æ®ä¸è¶³æ— æ³•è®¡ç®—è¯¥æŒ‡æ ‡"ã€‚
       - èµ„é‡‘æµå‘æˆ–è¡Œä¸šå¯¹æ¯”æ•°æ®ç¼ºå¤±æ—¶ï¼Œå¿…é¡»è¯´æ˜"æ•°æ®æš‚ä¸å¯ç”¨"ã€‚
    5. **åŒè§†è§’æ“ä½œå»ºè®® (æ ¸å¿ƒ)**: 
       - **é’ˆå¯¹ã€æŒä»“è€…/å·²è´­ ETF è€…ã€‘**: å¿…é¡»ç»™å‡ºå…·ä½“çš„åç»­ç­–ç•¥ï¼ˆå¦‚ï¼šç»§ç»­æŒæœ‰ã€é€¢é«˜å‡ä»“ã€å®šæŠ•åšæŒã€æˆ–æ­¢æŸç¦»åœºï¼‰ã€‚
       - **é’ˆå¯¹ã€æœªæŒä»“è€…/æ‹Ÿè´­ ETF è€…ã€‘**: å¿…é¡»ç»™å‡ºå…·ä½“çš„å…¥åœºæŒ‡å¼•ï¼ˆå¦‚ï¼šå½“å‰å¯å»ºä»“ã€ç­‰å¾…å›è°ƒã€åˆ†æ‰¹å®šæŠ•ã€æˆ–è§‚æœ›ï¼‰ã€‚
    6. **ä¿®å¤æ¸…å•å›åº” (é‡è¦)**: 
       - **å¦‚æœæä¾›äº†ä¿®å¤æ¸…å•ï¼Œå¿…é¡»åœ¨æŠ¥å‘Šä¸­é€é¡¹å›åº”é£æ§å®˜æå‡ºçš„å…·ä½“é—®é¢˜**
       - **é’ˆå¯¹æ¯ä¸ªä¿®å¤é¡¹ï¼Œæ˜ç¡®è¯´æ˜"å·²ä¿®æ­£"æˆ–"æ— æ³•ä¿®æ­£çš„åŸå› "**
       - **ç¡®ä¿ä¿®æ­£åçš„æŠ¥å‘Šç›´æ¥å›åº”äº†é£æ§å®˜çš„å…³åˆ‡ç‚¹**
       - **åœ¨æŠ¥å‘Šå¼€å¤´å¢åŠ "ä¿®æ­£è¯´æ˜"éƒ¨åˆ†ï¼Œæ€»ç»“æœ¬æ¬¡ä¿®æ­£çš„å†…å®¹**
    7. **ä¸“ä¸šåŒ–è¾“å‡º**: ä½¿ç”¨ Markdown æ ¼å¼ã€‚
    8. **åˆè§„æ€§å£°æ˜**: åœ¨æŠ¥å‘Šæœ«å°¾å¿…é¡»åŒ…å«ä»¥ä¸‹å£°æ˜ï¼š"æœ¬æŠ¥å‘Šä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚æŠ•èµ„è€…æ®æ­¤æ“ä½œï¼Œé£é™©è‡ªæ‹…ã€‚"
    
    ### æŠ¥å‘Šæ¨¡æ¿ç»“æ„
    - **ä¸€ã€æ ¸å¿ƒè¯„çº§ä¸ä¸€å¥è¯æ€»è¯„**
    - **äºŒã€æ¿å—/è‚¡ç¥¨æ‘˜è¦æ•°æ®è¡¨** (Markdown Table)
    - **ä¸‰ã€å¤šç»´æ·±åº¦é€»è¾‘åˆ†æ**
    - **å››ã€é’ˆå¯¹æ€§æ“ä½œç­–ç•¥ (åˆ†è§†è§’)**
    - **äº”ã€æ½œåœ¨é£é™©è­¦ç¤º**
    - **å…­ã€å…è´£å£°æ˜**
    """
    
    prompt = ChatPromptTemplate.from_template(prompt_template)
    
    try:
        # å‡†å¤‡æ•°æ®ï¼Œæˆªæ–­è¿‡é•¿çš„å†…å®¹
        news_analysis = state.get("news_analysis", "æš‚æ— åˆ†æ")
        sentiment_score = state.get("sentiment_score", 0.0)
        news_parse_success = state.get("news_parse_success", True)
        
        # å¦‚æœèµ„è®¯è§£æå¤±è´¥ï¼Œå¼ºåˆ¶ä¿®æ”¹ä¸º"èµ„è®¯ç»´åº¦æ— æ³•è¯„ä¼°"
        if not news_parse_success:
            news_analysis = "èµ„è®¯ç»´åº¦æ— æ³•è¯„ä¼°ï¼šç”±äºèµ„è®¯æ•°æ®è§£æå¤±è´¥æˆ–æš‚æ— å¯ç”¨æ•°æ®ï¼Œæ— æ³•è¿›è¡Œèµ„è®¯ç»´åº¦çš„åˆ†æã€‚è¯·åŸºäºæŠ€æœ¯é¢å’ŒåŸºæœ¬é¢æ•°æ®åšå‡ºæŠ•èµ„å†³ç­–ã€‚"
            sentiment_score = 0.0
        
        if len(news_analysis) > 2000:
            news_analysis = news_analysis[:2000] + "..."

        chain = prompt | llm
        res = chain.invoke({
            "news_analysis": news_analysis,
            "sentiment_score": sentiment_score,
            "quant_data": state.get("quant_data", {}),
            "tech_indicators": state.get("technical_indicators", {}),
            "sector_cons": state.get("sector_cons", [])[:10] if is_sector else []
        })
        
        # æå–æ€è€ƒè¿‡ç¨‹
        reasoning = res.additional_kwargs.get("reasoning_content", "")
        
        return {
            "strategy_report": res.content,
            "reasoning_content": [{"agent": "ç­–ç•¥ä¸»ç†äºº", "content": reasoning if reasoning else "æœªè·å–åˆ°æ€è€ƒè¿‡ç¨‹"}]
        }
    except Exception as e:
        error_msg = f"ç­–ç•¥ä¸»ç†äººè¿è¡Œå‡ºé”™: {str(e)}"
        print(f"ğŸ’¥ {error_msg}")
        return {
            "strategy_report": "ç”Ÿæˆç­–ç•¥æŠ¥å‘Šå¤±è´¥",
            "error": error_msg
        }
